name: Build and Deploy Next.js app

on:
  push:
    branches:
      - "build-test"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: test
    permissions:
      contents: read
      packages: write

    steps:
      # Common setup steps
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
     
      - name: Set environment specific variables
        id: env_vars
        run: |
          echo "ENV_TAG=latest" >> $GITHUB_ENV
          echo "SHA_TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV
          echo "REPO_LOWER=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo '')" >> $GITHUB_ENV
          echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # Build step for test and production
      - name: Setup Node.js and build
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build
        env:
          CHAIN_ID: ${{ vars.CHAIN_ID }}
          RPC_URL: ${{ vars.RPC_URL }}
          USDC_CONTRACT_ADDRESS: ${{ vars.USDC_CONTRACT_ADDRESS }}
          CONTRACT_FACTORY_ADDRESS: ${{ vars.CONTRACT_FACTORY_ADDRESS }}
          USER_SERVICE_URL: ${{ vars.USER_SERVICE_URL }}
          CHAIN_SERVICE_URL: ${{ vars.CHAIN_SERVICE_URL }}
          CONTRACT_SERVICE_URL: ${{ vars.CONTRACT_SERVICE_URL }}
          WEB3AUTH_CLIENT_ID: ${{ secrets.WEB3AUTH_CLIENT_ID }}
          WEB3AUTH_NETWORK: ${{ vars.WEB3AUTH_NETWORK }}
          MOONPAY_API_KEY: ${{ secrets.MOONPAY_API_KEY }}
          MIN_GAS_WEI: ${{ vars.MIN_GAS_WEI }}
          BUILD_VERSION: ${{ env.BUILD_VERSION }}
          GIT_TAG: ${{ env.GIT_TAG }}
          GIT_SHA: ${{ env.GIT_SHA }}
        run: |
          yarn install
          yarn build
          mkdir -p .next/standalone
          # Debug: Check what files exist before copying
          echo "=== Checking build output ==="
          ls -la .next/
          ls -la .next/static/ || echo "No .next/static directory"
          find .next/static -name "*.css" || echo "No CSS files found"
          # Copy static assets required for standalone build
          mkdir -p .next/standalone/.next
          cp -r .next/static .next/standalone/.next/static || echo "Failed to copy static"
          cp -r public .next/standalone/public || echo "Failed to copy public"
          # Debug: Check what was copied
          echo "=== Checking copied files ==="
          ls -la .next/standalone/.next/static/ || echo "No copied static files"
          find .next/standalone -name "*.css" || echo "No CSS files in standalone"

      # Docker steps
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LOWER }}:${{ env.SHA_TAG }}
            ghcr.io/${{ env.REPO_LOWER }}:${{ env.ENV_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Deploy step
      - name: Deploy to GCP
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ vars.VM_IP }} >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/deploy_key -l gituser ${{ vars.VM_IP }} -vv '
             # Login to GitHub Container Registry
            docker login ghcr.io -u ${{ github.actor }} -p "${{ secrets.GITHUB_TOKEN }}"
            docker pull ghcr.io/${{ env.REPO_LOWER }}:${{ env.SHA_TAG }}
            docker stop ${{ vars.SERVICE_NAME }} || true
            docker rm ${{ vars.SERVICE_NAME }} || true
            docker run -d \
              --name ${{ vars.SERVICE_NAME }} \
              --network ${{ vars.DOCKER_NETWORK }} \
              --restart unless-stopped \
              -e CHAIN_ID=${{ vars.CHAIN_ID }} \
              -e RPC_URL=${{ vars.RPC_URL }} \
              -e CHAIN_SERVICE_URL=${{ vars.CHAIN_SERVICE_URL }} \
              -e USER_SERVICE_URL=${{ vars.USER_SERVICE_URL }} \
              -e CONTRACT_SERVICE_URL=${{ vars.CONTRACT_SERVICE_URL }} \
              -e WEB3AUTH_CLIENT_ID=${{ secrets.WEB3AUTH_CLIENT_ID }} \
              -e WEB3AUTH_NETWORK=${{ vars.WEB3AUTH_NETWORK }} \
              -e MOONPAY_API_KEY=${{ secrets.MOONPAY_API_KEY }} \
              -e GIT_TAG=$(git describe --tags --abbrev=0) \
              -e GIT_SHA=$(git rev-parse --short HEAD) \
              -e COOKIE_DOMAIN=${{ vars.COOKIE_DOMAIN }} \
              -e BUILD_VERSION=${{ env.BUILD_VERSION }} \
              -e CONTRACT_FACTORY_ADDRESS=${{ vars.CONTRACT_FACTORY_ADDRESS }} \
              -e USDC_CONTRACT_ADDRESS=${{ vars.USDC_CONTRACT_ADDRESS }} \
              -e MIN_GAS_WEI=${{ vars.MIN_GAS_WEI }} \
              ghcr.io/${{ env.REPO_LOWER }}:${{ env.SHA_TAG }}
            '
