<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conduit Checkout Integration Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      line-height: 1.6;
      color: #333;
    }
    h1 {
      color: #2563eb;
      border-bottom: 2px solid #2563eb;
      padding-bottom: 10px;
    }
    h2 {
      color: #1e40af;
      margin-top: 40px;
    }
    .button {
      display: inline-block;
      padding: 12px 24px;
      margin: 10px 10px 10px 0;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
    }
    .button:hover {
      background: #1d4ed8;
    }
    .button-outline {
      background: white;
      color: #2563eb;
      border: 2px solid #2563eb;
    }
    .button-outline:hover {
      background: #eff6ff;
    }
    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 20px 0;
    }
    .code-block code {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 14px;
    }
    .success {
      background: #dcfce7;
      border: 1px solid #22c55e;
      color: #166534;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .info {
      background: #dbeafe;
      border: 1px solid #3b82f6;
      color: #1e40af;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .product-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      background: #f9fafb;
    }
    .product-card h3 {
      margin-top: 0;
    }
    #status {
      display: none;
    }
  </style>
</head>
<body>
  <h1>üöÄ Conduit Checkout Integration Example</h1>

  <p>This page demonstrates how to integrate Conduit's secure escrow payment system into your website. Click the buttons below to see different integration modes.</p>

  <div id="status"></div>

  <h2>Live Examples</h2>

  <div class="product-card">
    <h3>Basic Product - $10.00</h3>
    <p>Simple one-time payment with popup checkout</p>
    <button class="button" onclick="openBasicCheckout()">
      Pay $10 with USDC
    </button>
  </div>

  <div class="product-card">
    <h3>Enterprise Plan - $200.00</h3>
    <p>Full page redirect checkout with USDT option</p>
    <button class="button button-outline" onclick="openRedirectCheckout()">
      Pay $200 with USDT
    </button>
  </div>

  <div class="product-card">
    <h3>Custom Amount</h3>
    <p>Let users choose their own amount</p>
    <input type="number" id="customAmount" placeholder="Enter amount" value="25" step="0.01" min="1.001" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 10px;">
    <button class="button" onclick="openCustomAmountCheckout()">
      Pay Custom Amount
    </button>
  </div>

  <h2>Integration Code</h2>

  <h3>1. Include the Script</h3>
  <div class="code-block"><code>&lt;script src="https://app.instantescrow.nz/conduit-checkout.js"&gt;&lt;/script&gt;</code></div>

  <h3>2. Initialize with Your Config</h3>
  <div class="code-block"><code>&lt;script&gt;
  ConduitCheckout.init({
    // REQUIRED: Your wallet address to receive payments
    sellerAddress: '0x4f118f99a4e8bb384061bcfe081e3bbdec28482d',

    // REQUIRED: Base URL of Conduit checkout page
    baseUrl: 'https://app.instantescrow.nz',

    // RECOMMENDED: Auto-send verified payments to your backend
    webhookUrl: 'https://yoursite.com/api/conduit-webhook',
    webhookSecret: 'your-secret-key',  // Store securely!

    // Optional: Default token (USDC or USDT)
    tokenSymbol: 'USDC',

    // Optional: Days until auto-release to seller (default: 7)
    expiryDays: 7,

    // Optional: Display mode ('popup' or 'redirect')
    mode: 'popup',

    // Success callback (webhook already sent!)
    onSuccess: function(data) {
      console.log('Payment verified!', data);
      // Webhook already sent to your backend!
      // Just show UI confirmation
      alert('Thank you! Order confirmed!');
    },

    // Error callback
    onError: function(error) {
      console.error('Payment failed:', error);
      alert('Payment failed: ' + error);
    },

    // Cancel callback
    onCancel: function() {
      console.log('Payment cancelled');
      alert('Payment cancelled');
    }
  });
&lt;/script&gt;</code></div>

  <h3>3. Add Payment Buttons</h3>
  <div class="code-block"><code>&lt;!-- Simple button --&gt;
&lt;button onclick="ConduitCheckout.open({
  amount: '50.00',
  description: 'Premium Product'
})"&gt;
  Pay $50 with USDC
&lt;/button&gt;

&lt;!-- Button with more options --&gt;
&lt;button onclick="ConduitCheckout.open({
  amount: '100.00',
  description: 'Order #1234 - Widget Bundle',
  orderId: '1234',
  email: 'customer@example.com',
  tokenSymbol: 'USDT',
  expiryDays: 14,
  webhookUrl: 'https://yoursite.com/webhook',
  metadata: { sku: 'WIDGET-001', quantity: 2 }
})"&gt;
  Pay $100 with USDT
&lt;/button&gt;</code></div>

  <h2>API Reference</h2>

  <h3>ConduitCheckout.init(options)</h3>
  <p>Initialize the checkout widget with your configuration:</p>
  <ul>
    <li><code>sellerAddress</code> (required) - Your wallet address to receive payments</li>
    <li><code>baseUrl</code> (required) - Base URL of the Conduit checkout page</li>
    <li><code>webhookUrl</code> (recommended) - Your backend endpoint to receive verified payments</li>
    <li><code>webhookSecret</code> (recommended) - Secret key for HMAC signature verification</li>
    <li><code>tokenSymbol</code> (optional) - Default token: 'USDC' or 'USDT' (default: 'USDC')</li>
    <li><code>expiryDays</code> (optional) - Days until auto-release (default: 7)</li>
    <li><code>mode</code> (optional) - Display mode: 'popup' or 'redirect' (default: 'popup')</li>
    <li><code>onSuccess</code> (optional) - Success callback function (webhook already sent!)</li>
    <li><code>onError</code> (optional) - Error callback function</li>
    <li><code>onCancel</code> (optional) - Cancel callback function</li>
  </ul>

  <h3>ConduitCheckout.open(params)</h3>
  <p>Open a checkout for a specific payment:</p>
  <ul>
    <li><code>amount</code> (required) - Payment amount (e.g., '50.00')</li>
    <li><code>description</code> (required) - Payment description</li>
    <li><code>orderId</code> (optional) - Your order/transaction ID</li>
    <li><code>email</code> (optional) - Customer email address</li>
    <li><code>tokenSymbol</code> (optional) - Override default token for this payment</li>
    <li><code>expiryDays</code> (optional) - Override default expiry for this payment</li>
    <li><code>expiryTimestamp</code> (optional) - Custom expiry Unix timestamp</li>
    <li><code>webhookUrl</code> (optional) - Webhook URL for payment verification</li>
    <li><code>metadata</code> (optional) - Custom metadata object</li>
  </ul>

  <h3>ConduitCheckout.close()</h3>
  <p>Programmatically close any open checkout.</p>

  <h2>üîê Webhook Integration (RECOMMENDED)</h2>
  <p>Configure <code>webhookUrl</code> and the SDK will automatically POST verified payment data to your backend:</p>

  <h3>Webhook Payload:</h3>
  <div class="code-block"><code>POST /api/conduit-webhook
Headers:
  Content-Type: application/json
  X-Conduit-Signature: hmac-sha256-signature

Body:
{
  "contractId": "abc123",
  "chainAddress": "0x123abc...",
  "seller": "0x4f118f...",
  "amount": 50.0,
  "currencySymbol": "USDC",
  "state": "ACTIVE",
  "verified": true,
  "verifiedAt": "2025-12-30T14:30:00Z",
  "orderId": "YOUR-ORDER-123",
  "email": "customer@example.com",
  "metadata": { "sku": "WIDGET-001" },
  "timestamp": 1735568400
}</code></div>

  <h3>Verification Example (Node.js):</h3>
  <div class="code-block"><code>const crypto = require('crypto');

app.post('/api/conduit-webhook', async (req, res) => {
  // 1. Verify HMAC signature
  const signature = req.headers['x-conduit-signature'];
  const payload = JSON.stringify(req.body);

  const expectedSig = crypto
    .createHmac('sha256', process.env.WEBHOOK_SECRET)
    .update(payload)
    .digest('hex');

  if (signature !== expectedSig) {
    return res.status(401).json({ error: 'Invalid signature' });
  }

  // 2. Process verified payment
  const { contractId, amount, orderId } = req.body;
  await db.orders.update(orderId, { status: 'PAID' });
  await fulfillment.ship(orderId);

  res.json({ received: true });
});</code></div>

  <!-- Load the Conduit Checkout library -->
  <script src="/conduit-checkout.js"></script>

  <!-- Initialize for this demo -->
  <script>
    // Initialize with demo configuration
    ConduitCheckout.init({
      sellerAddress: '0x4f118f99a4e8bb384061bcfe081e3bbdec28482d', // Replace with your address
      baseUrl: window.location.origin, // Use same origin for demo
      tokenSymbol: 'USDC',
      expiryDays: 7,
      mode: 'popup', // Will be overridden per button

      onSuccess: function(data) {
        console.log('‚úÖ Payment verified!', data);

        // WEBHOOK ALREADY SENT!
        // If you configured webhookUrl, your backend already received the
        // verified payment data. Just show UI confirmation here.

        // IMPORTANT: In production with webhooks:
        // 1. Configure webhookUrl in init()
        // 2. Your backend receives verified data automatically
        // 3. Backend marks order as PAID
        // 4. Backend triggers fulfillment (ship goods)
        // 5. Backend sends confirmation email to customer
        // 6. onSuccess just shows UI: "Thank you! Order confirmed!"

        showVerifiedPayment(data);
      },

      onError: function(error) {
        console.error('‚ùå Payment verification failed:', error);
        showError(error);
      },

      onCancel: function() {
        console.log('üö´ Payment cancelled');
        showCancelled();
      },

      onVerifying: function(data) {
        console.log('üîç Verifying payment...', data);
        showVerifying(data.contractId);
      }
    });

    function openBasicCheckout() {
      ConduitCheckout.config.mode = 'popup';
      ConduitCheckout.open({
        amount: '10.00',
        description: 'Basic Product - One-time Payment',
        orderId: 'BASIC-' + Date.now(),
        tokenSymbol: 'USDC'
      });
    }

    function openRedirectCheckout() {
      ConduitCheckout.config.mode = 'redirect';
      ConduitCheckout.open({
        amount: '200.00',
        description: 'Enterprise Plan - Annual License',
        orderId: 'ENTERPRISE-' + Date.now(),
        expiryDays: 14,
        tokenSymbol: 'USDT'
      });
    }

    function openCustomAmountCheckout() {
      const amount = document.getElementById('customAmount').value;
      if (!amount || parseFloat(amount) < 1.001) {
        alert('Please enter an amount of at least $1.001');
        return;
      }

      ConduitCheckout.config.mode = 'popup';
      ConduitCheckout.open({
        amount: amount,
        description: 'Custom Amount Payment',
        orderId: 'CUSTOM-' + Date.now(),
        tokenSymbol: 'USDC'
      });
    }

    function showVerifying(contractId) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = 'info';
      statusDiv.innerHTML = `
        <h3>üîç Verifying Payment...</h3>
        <p>Contract ID: ${contractId}</p>
        <p>Please wait while we verify your payment on the blockchain...</p>
        <div class="spinner"></div>
      `;
      statusDiv.style.display = 'block';
    }

    function showVerifiedPayment(data) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = 'success';
      statusDiv.innerHTML = `
        <h2>‚úÖ Payment Verified Successfully!</h2>

        <div class="payment-details">
          <h3>Payment Details:</h3>
          <table>
            <tr>
              <td><strong>Contract ID:</strong></td>
              <td>${data.contractId}</td>
            </tr>
            <tr>
              <td><strong>Amount:</strong></td>
              <td>${data.amount} ${data.currencySymbol}</td>
            </tr>
            <tr>
              <td><strong>Seller:</strong></td>
              <td>${data.seller}</td>
            </tr>
            <tr>
              <td><strong>Status:</strong></td>
              <td><span class="badge ${data.state.toLowerCase()}">${data.state}</span></td>
            </tr>
            <tr>
              <td><strong>Blockchain Address:</strong></td>
              <td style="word-break: break-all; font-family: monospace; font-size: 0.85em;">${data.chainAddress || 'Pending'}</td>
            </tr>
            <tr>
              <td><strong>Verified:</strong></td>
              <td>${data.verified ? '‚úì Yes (Backend Confirmed)' : '‚úó No'}</td>
            </tr>
            <tr>
              <td><strong>Verified At:</strong></td>
              <td>${new Date(data.verifiedAt).toLocaleString()}</td>
            </tr>
          </table>
        </div>

        <div class="next-steps">
          <h3>What Happens Next:</h3>
          <ul>
            <li>‚úì Your payment is secured in blockchain escrow</li>
            <li>‚úì Merchant will ship your goods</li>
            <li>‚úì Your purchase is protected for ${data.expiryDays || 7} days</li>
            <li>‚úì Funds auto-release to seller after protection period (if no disputes)</li>
            <li>‚úì You can dispute before funds are released if there's a problem</li>
          </ul>
        </div>

        <div class="merchant-note">
          <h4>üì¶ For Merchants:</h4>
          <p>Payment has been verified! You can now safely ship the goods.</p>
          <p><strong>RECOMMENDED:</strong> Configure <code>webhookUrl</code> in the SDK init() and your backend will receive this data automatically. No manual fetch() calls needed!</p>
          <p><strong>Alternative:</strong> You can manually send this data to your backend from onSuccess, but webhooks are more reliable (work even if user closes browser).</p>
        </div>
      `;
      statusDiv.style.display = 'block';
      // NO setTimeout - leave it visible permanently!
    }

    function showError(error) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = 'error';
      statusDiv.innerHTML = `
        <h2>‚ùå Payment Verification Failed</h2>
        <p><strong>Error:</strong> ${error}</p>
        <div class="error-help">
          <h3>What to do:</h3>
          <ul>
            <li>Check the browser console for more details</li>
            <li>Verify you have sufficient USDC balance</li>
            <li>Contact support with the error message above</li>
          </ul>
        </div>
        <button onclick="location.reload()">Try Again</button>
      `;
      statusDiv.style.display = 'block';
    }

    function showCancelled() {
      const statusDiv = document.getElementById('status');
      statusDiv.className = 'info';
      statusDiv.innerHTML = `
        <h2>üö´ Payment Cancelled</h2>
        <p>The payment was cancelled by the user.</p>
        <button onclick="location.reload()">Start Over</button>
      `;
      statusDiv.style.display = 'block';
    }
  </script>
</body>
</html>
